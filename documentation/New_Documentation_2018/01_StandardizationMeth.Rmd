---
title:   |
    | Standardization & Balancing
    | Overall Workflow of the new methodology
    |  
header-includes:
- \usepackage{draftwatermark}   
- \usepackage{makeidx}
- \makeindex
- \usepackage{float} #use the 'float' package
- \floatplacement{figure}{H} #make every figure with caption = h
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{amsthm}
- \usepackage{mathtools}
author:
- Cristina Muschitiello\

  Food and Agriculture Organization of the United Nations
  
abstract: |
  This vignette provides a description of the Workflow of the Standardization and Balancing Procedure: This represents the process of aggregating and balancing all the accounts of individual products to their primary equivalents. Other documents will provide details of each step of the overall procedure.
date: "`r format(Sys.time(), '%e %B %Y')`"
geometry: margin=1in
output:
  pdf_document:
    keep_tex: true
    fig_caption: yes
    includes:
      in_header: header.tex
    pandoc_args: [
    --tab-stop=2
    ]
    number_sections: true
    toc: true
    toc_depth: 4
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# local({
# r <- getOption("repos")
# r["faoswsCRAN"] <- "http://hqlprsws1.hq.un.fao.org/fao-sws-cran/"
# options(repos = r)
# })
## load the library
# library(faosws)
# library(faoswsUtil)
# library(faoswsBalancing)
# library(faoswsStandardization)
library(tinytex)
library(data.table)
library(igraph)
library(stringr)
library(dplyr)
library(MASS) 
library(lattice)
library(reshape2)
library(kableExtra)
library(captioner)
library(xtable)
```


```{r}
# DEFINE ALL TABLE NAMES AND CAPTIONS
table_nums <- captioner::captioner(prefix = "Table")
t1_cap <- table_nums(name = "t1",
                     caption = "Unbalanced Sua table (Example China Mainland, Wheat 2014)")
t2_cap <- table_nums(name = "t2", 
                        caption = "Sua table with Imb1 (Example China Mainland, Wheat 2014)")

t3_cap <- table_nums(name = "t3", 
                        caption = "Sua table with Production filled/incremented (Example China Mainland, Wheat 
2014)")

t4_cap <- table_nums(name = "t4", 
                        caption = "Parent/child eR and shares")

t5_cap <- table_nums(name = "t5", 
                        caption = "Sua table with Food Processing filled (Example China Mainland, Wheat 2014)")

t6_cap <- table_nums(name = "t6", 
                        caption = "Sua table with Imb2 (Example China Mainland, Wheat 2014)")

t7_cap <- table_nums(name = "t7", 
                        caption = "Sua table with utilizations filled (Example China Mainland, Wheat 2014)")

t8_cap <- table_nums(name = "t8", 
                        caption = "Utilization Table Wheat and meslin Flour China Mainland 2014")

t9_cap <- table_nums(name = "t9", 
                        caption = "Utilization Table Bran of Wheat China Mainland 2014")

t10_cap <- table_nums(name = "t10", 
                        caption = "Rank Weight of the elements of FBS")

t11_cap <- table_nums(name = "t11", 
                        caption = "Sua line of Cocoa Beans Madagascar 2014 - before Sua Filling")

t12_cap <- table_nums(name = "t12", 
                        caption = "Utilization table for Cocoa Beans Madagascar")

t13_cap <- table_nums(name = "t13", 
                        caption = "Sua line of Cocoa Beans Madagascar 2014 - after Sua Filling")


```


# Disclaimer {-}

This Working Paper should not be reported as representing the official view of
the FAO. The views expressed in this Working Paper are those of the
author and do not necessarily represent those of the FAO or FAO
policy. Working Papers describe research in progress by the authors and
are published to elicit comments and to further discussion.

This paper is dynamically generated on \today{} and is subject to
changes and updates.

\newpage

# The Food Balance Sheet Framework

## Introduction

A food balance sheet can be defined as an aggregated and analytical data set that "presents a comprehensive picture of the pattern of a country's food supply during a specified reference period."^[For this definition and a more extended description of the motivation behind the development of FBS, see FAO, 2001, *Food Balance Sheets: A Handbook*, available at: http://www.fao.org/docrep/003/X9892E/X9892E00.HTM. Accessed on 19 January 2017.] FBS are presented as products accounts, where the quantities allocated to all the sources of total supply must be equal to the quantities allocated to all the sources of utilization. This balance is compiled for every food item consumed within a country at primary commodity equivalent basis, and all of the primary commodity equivalent balances are then combined into a single overall FBS. FBSs are, then, expressed in terms of per capita supply for each food item by dividing by the country's population, with the per capita supplies being expressed both in terms of quantity and, through the application of food conversion factors, in terms of caloric value, protein, and fat content. These per capita estimates of caloric value for individual food products are then summed to obtain the total daily per capita Dietary Energy Supply (DES) of a country.

While FBS are typically only published at the primary commodity equivalent level to facilitate interpretation, they are created starting from information on all the derived products processed by each primary. For example, in most cases, a balance for wheat alone would in most cases include little or no food use, because wheat is commonly processed into flour before it is consumed by humans, and flour is then used to produce various other derived products such as bread, pastries and pasta. Because there is both supply and demand for each of these products (both primary and derived), individual accounts should be kept for both the primary product and all of its derived products. 
The process of obtaining FBS starting from product's accounts is the so-called standardization. This process starts from individual accounting balances for individual products and leads to the creation of a FBS for the primary commodity equivalent products, passing trough various steps, from  filling of missing data to the balancing of the account. In the FBS framework the *Central Product Classification (CPC)* System is used for classifying commodities^[The CPC represents a comprehensive classification of products into a system of categories that are both exhaustive and mutually exclusive. It is based on a set of internationally agreed concepts, definitions, principles and classification rules. The custodian of this classification is the UNSD. For more information, see the  [*Guidelines on International Classifications for Agricultural Statistics*](http://gsars.org/wp-content/uploads/2015/12/Guidelines-for-Int-Classifications-on-Agricultural-Statistics-web.pdf) and the [*UNSD official document on CPC Vesion 2.1*](https://unstats.un.org/unsd/cr/downloads/CPCv2.1_complete%28PDF%29_English.pdf)].

All the steps of the standardization process are performed inside the standardization & Balancing module, described in this document.

## The Balancing equation and its variables

At the most basic level, Food Balance Sheets are, like all commodity balances, simple identities. In these identities, the sum of all supply variables is equal to the sum of all demand variables; the two most common identities set domestic supply equal to domestic demand (first equation) or total supply equal to total demand (second equation). 

\begin{equation}
\label{eq:balance1}
P_{ijt} + I_{ijt} - X_{ijt} - \Delta St_{ijt} = Fo_{ijt} + Fe_{ijt} + Lo_{ijt} + Se_{ijt} + IU_{ijt} + T_{ijt}  + ROU_{ijt}
\end{equation}
\begin{equation}
\label{eq:balance2}
P_{ijt} + I_{ijt} - \Delta St_{ijt} = X_{ijt} + Fo_{ijt} + Fe_{ijt} + Lo_{ijt} + Se_{ijt} + IU_{ijt} + T_{ijt} + ROU_{ijt}
\end{equation}

where:

 * $P$=Production
 * $I$=Imports
 * $X$=Exports
 * $S$=Stock level
 * $\Delta St_{t}$ = Stock Variation = $St_{t} - St_{t-1}$
 * $Fo$=Food availability 
 * $Fe$=Feed
 * $Lo$=Losses
 * $Se$=Seed 
 * $IU$=industrial use 
 * $T$=Tourist consumption 
 * $ROU$=Residual Other Use.  


In the equation the $i$ index runs over all countries, the $j$ index over all commodities, and $t$ over years.
Ideally, as many variables as possible should be measured and measurement should take place with a maximum degree of accuracy. At international level, the primary data source that FAO uses to compile the the Supply Utilization Accounts/Food Balance Sheets are the data as collected through the annual *Agriculture Production Questionnaires*. In reality, measured values are mostly limited to variables on the supply side (production, imports and exports), while, on the demand side, most estimates are imputed data. Moreover, some of the variables on the demand side are never measured and are always calculated during the standardization process itself. In particular^[For more details on FBS variables please see the latest version of the *Resource Book*]:


 * *Production (P)*: Data on production are data at farmgate level. As data on production are very important for countries, these data are very often survey-based data. Nevertheless, not all countries collect data of production for all commodities. Therefore other data collecion methods are used, like records of private firms and commodity organization. When no other data are available Production is imputed or estimated. Imputation and estimation procedures depends on the specific commodity. There are different for crops and livestock but all based on an *ensemble approach*^[See *Production module* documentation for more details*. Production data in the FBS framework are needed for all the primary commodities and for a set of derived commodities.

 * *Import(I) and Export(X)*: Data on Trade are, mainly, official from international trade databases, like UNSD and EUROSTAT, at HS6 commodity level^[Harmonized Commodity Description and Coding Systems (HS) is an internationalclassification of products held by UNSD. Is made of six-digit level codes and used worldwide for trading data classifications. See official [*HS6 UNSD webpage*](https://unstats.un.org/unsd/tradekb/Knowledgebase/50018/Harmonized-Commodity-Description-and-Coding-Systems-HS) for mode details]. Official data are integrated with supplementary data having the main aim of filling in all the information hidden by the unrecorded trade and coming, mainly, from trading partners. HS6 classification is more detailed than the used CPC classiffication, therefore, these data are aggregated in CPC commodities before being used in the standardization process^[See [*Trade module*](https://github.com/SWS-Methodology/faoswsTrade/blob/master/vignettes/Documentation/tradeDocumentation.pdf) documentation for more details]. 

 * *Stock Variation (*$\Delta St_{t})$: In the FBS framework, stocks are considered as *changes in stocks* from one time period to the next. Moreover they are considered as a component of supply. Therefore, the - sign indicates that the stock is decreased, which means that the stocks are available as a supply, while the + sign indicates that the stocks have increased and they are, therefore, considered as a utilization of that commodity. Changes in stocks are tipically limited to a short number of commodities, mainly grains, pulses and sugar and, because they are very rarely measured by country, figures are very often imputed or estimated^[For a complete list of stock commodities and for details about the imputation methodology, please refer to specific documentation for stock}. Estimation of Changes in stock is based on opening stocks figures throught an approach that mantain time consistency of data that are available and official^[All data are marked as $official$, $semi-official$ or *unofficial*, depending on the source they come from, throught $flags$. Flag management is one of the core responsibilities of the *Office of the Chief Statistician* Department in FAO. Flags are used from all the estimation procedure for distinguishing between different level of reliability in the data. The most reliable data are used to estimate missing or less reliable data.[this has to be better specified]]. 

 * *Food availability (Fo)*: Food availability is defined as the quantity of any substance that is available for human consumption at the retail level by the country's resident population during a given reference period. Official data of food availability come from questionnaires, industrial ouptut surveys and household consumption or expenditure surveys. When these sources of data are not available, food availability data are imputated or estimated. Not all CPC commodities are Food commodities, as not all commodities are used for human consumption. Food commodities are divided in two main groups: *Food Estimates* and *Food Residual* and estimated differently depending on the pertaining group, respectively as linear or logaritmic function of income elasticity of demand, GDP per capita, and population, or as residual quantity of production and net trade quantities^[For a complete list of food commodities of the two typologies and for details about the imputation methodology, please refer to specific documentation for Food availablity]. 

 * *Feed (Fe)*: Feed demand is increasing because of the increase of income in developing countries. Animal feed may vary among countries due to the difference in livestock and the diversity of commodity used for livestock's rations among different countries. Official feed demand data might be available from specific questionnaires. Even when available, these data need to be cross-checked against livestock availability in terms of requirements. When official data, and also other sources of semi-official data, are not available, feed data are estimated as a function of livestock availability and livestock feed demand in terms of energy and protein requirements, in accordance with an inventory of the potential feed supply's products of any country.

 * *Seed (Se)*: Official seed data may come from agricultural surveys, while other sources of data might be found in some technical publication. When data are not available these are estimated as a function of a seeding rate and a sown area in the following year.

 * *Tourism Consumption (T)*: Tourism consumption is considered here as a separate utilization variable, while in the past it was included in the "other utilization" catchall cathegory. Official data for this variable are rare and may come from tourism offices or collected by tourism boards trought surveys. UNWTO is an alternative source of data or other authorities. Imputations and estimations of tourist food are made as a function of food figures. 

 * *Industrial Use (IU)*: This variable refers to utilization of any food items in any non-food industry. Non-food use of food commodities is growing and is highly context and country specific. For this reason there are not, at the moment, suggestions on how to impute and estimate missing figures. As a consequence, Industrial data available for Food Balance Sheets are only those coming from Official or unofficial sources. At the moment the data used comes from USDA and from questionnaries.

 * *Loss (L)*: FAO has developed the Global Food Loss Index (GFLI) that focuses on the supply-side aspects of improving the efficiency of global food supply chains. The index is based on a set of primary commodities that are key in agricultural production systems, including crops, livestock, and fisheries. In order to track losses without compounding production variability, losses are expressed as a percentage and are aggregated using fixed quantities and prices.
The primary data source that FAO uses for compiling GFLI are loss factors as collected by Questionnaires. Other sources are publications and reports from subnational reports, academic institutions, international organizations and so on. The missing data are imputed using a hyerarchical model based on commodity groups^[ask for links to a proper documentation].

 * *Residual and other use (ROU)*: ROU is used to capture categories of products that do not follow in any other category and that might be considered "not important" for the FBS scope. Normally, these residual commodities are different from country to country and for this reason they fall in this variable. RoU are set not to be higher that 5\% of total supply and are calculated at-post as absorbing element, in the sense that it absorbs part or all of the imbalance that may exist, at FBS commodity aggregate level, after the standardization process. Any imbalance bigger than 5\% of totla supply is balanced thrugh a balancing mechanism that will be later specified. 

One more variabel has to be mentioned which is not included in the function, because is somehow inluded in *Production*, but is very important in the process of creating FBS. This is the *Food Processing*. 

 * *Food Processing (FP)*: This variable represents the amount of the availability of a commodity that enter a manufacturing process to be tranformed in a derived commodity. Food processing is not officially measured, nor collected via official sources. This variable is entirely calculated during the standardization process by applying extraction rates to the amount of production of the derived commodity. This will be better specified in section XXX of the present document.

# The Workflow

## Data Pull

The process starts by considering the initial SUA for each commodity, primary and derived, with the different variables of the equation (as listed and briefly described in the previous section) filled with figures as available from official or other sources and from imputation and estimation method, when applied. In other words, the Process starts by pulling figures inside a so-called *SUA unbalanced*. In this initial account food processing and RoU figures are not available (because they, by default, will be measured during the process), whereas the figures for all other variables have been already collected, imputed and estimated through specific *module* (Figure \ref{fig:f1}). 

```{r f1, fig.cap = "\\label{fig:f1}Data Pull from datasets containing data for each separate variable"}
knitr::include_graphics("images/01_pulldata.pdf")
```

A module, in the FBS Framework, is an R-script, written by an R-developer, for the execution of a set of operations (either data import, manipulation, imputation or estimation) required for compiling the time series of one variable. There is at least one module (there might be more) for each variable of the FBS. Each module produces figures that are collected in a dataset inside the *Statistical Working System (SWS)*^[SWS is an internal Working System providing a platform for statisticians and statistical clers to collect, collate, validate and correct data. Moreover, the platfors supports the possibility of performing imputations of data based on statisticians' knowledge and development.].Output data of a module may become input data of another module, this creating a precise sequence for the execution of a complete FBS. IN the present document we are analyzing the workflow of the Standardization process as starts after all the module have run and have produced reliable data or each variable. The detailed description of the workflow for the execution of al the module of the FBS is described in a separate document^[[report the document when it will be available]].

## the Initial Sua Unbalanced 

After pulling all data, the process of compiling Food Balance Sheets is a non-complete supply-utilization account. The non-completeness of the SUAs is due to different reasons: first, as already said, some variables are not collected, nor estimated before the process begins, second there is the model for industrial use that does not impute or estimate data, but just collects data from different sources, this opening the strong possibility not to have values where they are supposed to exist and, also, not guaranteeing consistency of data over time. Thirdly, modules might, sometimes, fail in the imputation, because of the strong complexity and structural diversity of the input data. 

Supply utilization accounts are typically organized into tables where the SUA for the primary commodity is at the top, and the SUAs for all of the products derived from that commodity follow (`r table_nums("t1",display = "cite")`). Commodities in the SUA table are in a parent-child relationship representing a real commodity process. In the example of `r table_nums("t1",display = "cite")` the relationship between commodities is the following: 

 + Maize is processed in flour, Bran and Breakfast Cereals,
 + Flour of maize is processed into Starch and Gluten, Wafers, pastry, bread and pasta
 + Starch is processed into Glucose and Dextrose, 
 + Gluten and Bran are processed into some feed and meal,

All these relationships happens at different levels, creating a tree of relationships representing what is called the ***Commodity Tree***. In particular, our example represents the commodity tree of Wheat in China in 2014 and is displayed, in its graphical form, in Figure \ref{fig:f2}. A commodity Tree is the representation of all possible parent-child relationship between commodities at all levels and might be different from country to country. A better descritpion of Commodity tree is given in a separate document^[The reference document, at the moment is the *tecnical conversion factor* document available in the documentation folder on [*GitHub*](https://github.com/SWS-Methodology/faoswsStandardization/tree/master/documentation)]. 

```{r f2, fig.pos = 'H', fig.cap = "\\label{fig:f2}Commodity Tree for Wheat in China mainland 2014"}
knitr::include_graphics("images/02_WheatTree.pdf")
```

```{r t1, fig.cap=t1_cap}
table=data.table(read.csv("tables/01_sua_unbalanced.csv"))
landscape(knitr::kable(table,format="latex",caption = "Unbalanced Sua table (Example China Mainland, Wheat 2014)",
             align = c("r",rep("l",length(colnames(table))-1)))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down", full_width = T))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  row_spec(1, italic=TRUE) %>%
  column_spec(1,width = "12em")%>%
  column_spec(2:length(colnames(table)),width = "6em")%>%
  add_footnote( "P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses",notation = "symbol")
```

There are unbalanced SUAs for all combinations of commodity tree/country/year. These tables are the starting poin of the *Standardization and Balancing* process, which starts with the "Filling" of the missing figures in the SUAs.

## The *Sua Filling*

### Main rules and the rationale {-}

The Standardization, i.e. the conversion of the variables of any child commodity in primary-equivalent commodity, requires all variables of the SUAs to be filled (exept for ROU, which is a residual variable and is imputed at the very last step of theprocess), "all variables" meaning "all variables that are supposed to be filled". Indeed, not all variables have to exist for all commodities. Consider maize as an example: if there is no figure of *food availability* for maize, that does not mean that there is a missing figure, because maize is rarely used for human consumption directly. However, in some country people do eat raw maize and, therefore, for those countries a food figure is expected and, if missing, that has to be taken into account. 

A simplifided workflow of *Sua Filling* is reported in Figure \ref{fig:f3}. 

```{r f3, fig.align = "center", fig.pos = "H", out.width = "60%", fig.cap = "\\label{fig:f3}The Sua filling simplified workflow"}

knitr::include_graphics("images/03_SuaFilling.pdf")

```

*Food Processing* needs to be computed first, which does not come from any module. For the food processing to be correclty computed, a check on the other variables as to be performed, in order to be sure that the food processing might be correclty imputed. In particular, Production is checked first, as the *Food Processing* figure of any commodity is based on the production one. Then *Food processing* can be computed and, after that, other missing figures, if existing, are filled.

This last step requires two major and not straightforward steps, representing each a separate issue, for solving which, an algorithm has been developed that responds to the following rationale and rules:

1. *Identify which are the missing values that have to be filled.*
2. *Decide how to fill those missing values.*
3. *Preserving reliability of sources of data*

Not all the variables (supplies and utilizations) are to be filled:

 * Trade (import and Export) data are shared with countries and published by FAO. Therefore these figures have a separate process of validation that makes them reliable enough not to be questioned during the standardization process.
 * Production figures of primary commodities are also published by FAO. As previously mentioned, production values can have various flags which assign different degrees of reliability to these figures. The *sua filling* treats production figures accordingly to flags. 
 * Stock figures are also not touched during the process of filling. This decision was taken because the standardization process works year by year, while *stock variation* is a time-based variable that have to be always treated looking at the data over time. The cross year approach is incompatible with this characteristic. Any inconsistent or missing value for stock found would require to go back to the module imputing figures and check for possible errors. If no errors can be found, a manual correction would be required. 
 
Information about the remaining variables, which are all utilizations, is taken from FBSs and SUAs of past years. 
FBSs published with the previous methodology and their corresponding SUAs can give information about which are the utilizations supposed to be active for every single commodity in each country.  
Therefore, these information have to be given externally, as the process is automated and there is non-human knowledge intervening in training the machine that is performing the calculations. The previous methodology used for compiling FBS made massive use of manual interventions while the new methodology tries to avoid it, but taking advantage of the work and effort of the country experts that compiled the FBSs in the past. Past information are embedded in the new methodology trought the use of the *Utilization table* which helps idenifying which variables have to be filled, commodity by commodity, while the amount of the to be assiged to sigures is identified through a set of rules, known as *Sua filling*. This procedure makes use of the imbalance between supply and utilization values for each commodity and fills the figures that have been recognized as missing from the ***Utilization table***. The filling procedure assigns figures using an ad-hoc algorithm, called ***Inverse Ranking***, designed for dimensioning the figures in accordance with the importance they had in the past FBSs, as suggested also from the *Utilization table* through ranks associated to each variable. As a consequence, all the commodities entering the sua filling procedure are eventually balanced.  

Not all the commodities enter the process the same way. In particular, a distinction is made between primary commodties and derived commodities: 

 * Primary commodities are normally the commodities for which more reliable figures are produced. Moreover, FAO often publish information about primary commodities, therefore values are not expected to be modifyed during a computational process.
 * Derived commodities are more affected by modifications during this process, according to the flag of each figure.

Therefore, the steps of *Sua filling* process affect the SUA differently from line to line. Figure \ref{fig:f4} shows the general Workflow of the sua filling highlighting the distinction between primary and derived commodities.


```{r f4, fig.align = "center", out.width = "65%", fig.cap = "\\label{fig:f4}The Sua filling divesified workflow"}

knitr::include_graphics("images/04_SuaFilling2.pdf")

```


### Step 1: Filling of production figures {-}

Only Derived commodities are involved in this process. The sua filling detect the Production figures that need to be filled or modified, by looking at the following *Imbalance*: 

\begin{equation}
\label{eq:imbalance1}
Imb_{1} = P_{ijt} + I_{ijt} - X_{ijt}
\end{equation}

where $Imb_{1}$ is the Imbalance and is enumerated because is different from a second Imbalance that will enter into the process later. Here: 

 * If $Imb_{1} < 0$ there is no supply enough for the export and this is intepreted as the need for creating/incrementing the Production figure. The new production figure ($P^*_{ijt}$) is computed as: 
 
 \begin{equation}
\label{eq:imbalance1}
 P^*_{ijt} = P_{ijt} + Imb_{1}
\end{equation}
 
 * If $Imb_{1} >= 0$ there is enough supply and, therefore, no need for changing the production figure. 

The reason for excluding other Variables from the computation of the imbalance here is that, at this step of the process, Trade variables are the most reliable and those for which, to the highest level of probability, there are all the figures filled. In `r table_nums("t2",display = "cite")` *Imb1* of our example is reported. Notice that there are 3 rows with negative values, but one of them is considered Primary ommodity. Indeed, *Mixes and dough for the preparation of baker's wares* is a commodity never processed and, therefore, is considered primary commodity and added to wheat in the FBS item *Wheat and produts*. Consequently production of only 2 commodity is changes, as shown in `r table_nums("t3",display = "cite")`.


```{r t2, fig.cap=t2_cap}
table=data.table(read.csv("tables/02_sua_unbalanced_imb.csv"))
landscape(knitr::kable(table,format="latex",caption = "Sua table with Imb1 (Example China Mainland, Wheat 2014)",
             align = c("r",rep("l",length(colnames(table))-1)))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down", full_width = T))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  # row_spec(c(3,4,6),bold=FALSE, italic=FALSE,color = "red") %>%
  column_spec(3:length(colnames(table)),bold=FALSE, italic=FALSE,color = "black",width = "6em")%>%
  column_spec(1,width = "12em")%>%
  column_spec(14,color = "red",bold=T,italic=T)%>%
add_footnote( "P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses",notation = "symbol")
```


```{r t3, fig.cap=t3_cap}
table=data.table(read.csv("tables/03_sua_unbalanced_prod.csv"))
landscape(knitr::kable(table,format="latex",caption = "Sua table with Production filled/incremented (Example China Mainland, Wheat 2014)",
             align = c("r",rep("l",length(colnames(table))-1)))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down", full_width = T))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  row_spec(c(4,6),bold=T, italic=T,color = "red") %>%
  # column_spec(2,color = "red",width = "6em")%>%
  column_spec(3:length(colnames(table)),bold=FALSE, italic=FALSE,color = "black",width = "6em")%>%
  column_spec(1,width = "12em")%>%
add_footnote( "P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses",notation = "symbol")
```


### Step 2: Filling of food processing {-}

When Production has been checked, created or incremented, *Food Processing* can be calculated. Food processing is the amount of the supply of a commodity processed into derived commodities. *Food processing* is calculated for all the parent commodities as sum of the food processing of all the possible derived commodities. For example, Wheat in China is processed into Flour of Wheat, Bran of Wheatand Breakfast Cereals: Flour and Bran are produced during the same production process (they are called *co-products* or *by-products*), therefore the same amount of wheat is used for producing all of them, Breakfast Cereals comes from a separate production process instead. Therefore, *Food processing* of Wheat is given as sum of the amount of wheat's supply used for priducing Flour and Bran + The amount used for producing Breakfast Cereals. Calculation of Food processing happens by level, then after having calculated the amount for wheat, the amount of supply of flour of wheat used for producing Starch, Gluten, bread and the other derived of wheat flour becomes the *Food processing* of flour of Wheat and so on, for any subsequent level. 

The formula for calculating $FP$ is based on the production of the child product: 

 \begin{equation}
\label{eq:Food Processing}
FP_{p_{ijt}} = \sum \limits_{c=1}^C\biggl(\frac{P_{c_{ijt}}}{eR_{p\to c}}\biggr)\times s_{cp}\times w_{c}
\end{equation}

where: 

 * $FP_{p_{ijt}}$ is *Food processing* of the generic parent $p$.
 * $c = 1,2,3...C$ are the $C$ children $c$ of parent $p$.
 * $P_{c_{ijt}}$ is the Production of Child $c$.
 * $eR_{p\to c}$ is the *extraction Rate* from parent $p$ to child $c$. The Extraction rate represents how much amount of the child commodity is produced from 1 unit of parent commodity^[FBSs are normally expressed in tonnes.]. It is expressed as a ratio of the processed product obtained from the processing of the parent/originating product.
 * $s_{cp}$ is the *share* of child $c$ from parent $p$. Shares represent the amount of the child commodity that was produced from the specified parentand are expressed as a ratio Indeed, many products can be obtained from more than one parent (i.e. the commodity fruiti juice) and this requires to define the ratio coming from each parent. Shares are defined as: 

> \begin{equation}
\label{eq:shares}
s_{cp} = \frac{availability1_{p(c)}}{\sum \limits_{p=1}^A{availability1_{p(c)}}}
\end{equation}

> where $availability1_{p(c)}$ is the availability of each parent $p$ of child $c$ expressed in terms of $c$ (as say in *child equivalent*). Is is enumerated as $1$ because a slighlty different availability will be found in a following step: 

>>\begin{equation}
\label{eq:availability 1}
availability1_{p(c)} = (P_{p_{ijt}} + I_{p_{ijt}})\times eR_{p\to c}
\end{equation}


 * $w_{c}$ is the *weight* of child $c$. This parameter is used for identifying and treating co-product. Indeed, if the production of two or more co-prodiucts is used for producing *Food processing* of the parent commodity producing them, the result would be a Food processing twice the size of what it should be. This would happen because the two co-products are produced during the same process, in other words, fromt he same amount of the parent commodity. For this to be taken into account, a weight is used, which is 1 for the commodity that have to be considered for determining Food processing of parent commodity and 0 for the child commodity that are co-products (equation \ref{weight}). Please notice that, the co-products are still important in the standardization, because they contribute in the creation of the calories availability of the country, therefore, these commodities (Also called *zero weight* commodities) are multiplied by 0 only when quantities are treated, they will instead be considered when calories will be taken into account: 
 
>>\begin{equation}
\label{eq:weight}
\begin{cases}
    w_{c} = 1      & \quad \text{if boht quantity and calories have to be standardized} \\
    w_{c} = 0      & \quad \text{if only calories have to be standardized}
\end{cases}
\end{equation}


`r table_nums("t4",display = "cite")` contains the parent/child relationships, extraction rates and shares for *Food processing* computation of che wheat/China example.

```{r t4, fig.cap=t4_cap, fig.pos = "H"}
table=data.table(read.csv("tables/04_foodproc_calc.csv"))
knitr::kable(table,caption = "Parent/child eR and shares",
             align = c("r",rep("l",length(colnames(table))-1)))

```

This table reproduces the relationships of Figure \ref{fig:f2}. Shares lower than $1$ mean that the child commodity might be produced also from other parents and, therefore, the reported ratio represents the ratio of that commodity that is produced from the reported parent. For example, *Gluten Feed and Meal* is produced from *Wheat Gluten* and from *Bran of maize*. The sum of the shares associated to this child ($0.33$ and $0.67$) is equal to $1$.

`r table_nums("t4",display = "cite")` shows the SUA table after the two steps just described. Notice that, in the specific example, there was no need for the creation/incrementation of Production on any derived commodity because $Imb1$ is positive for all commodities. 

```{r t5, fig.cap=t5_cap}
table=data.table(read.csv("tables/05_sua_unbalanced_2.csv"))
landscape(knitr::kable(table,format="latex",caption = "Sua table with Food Processing filled (Example China Mainland, Wheat 2014)",
             align = c("r",rep("l",length(colnames(table))-1)))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down", full_width = T))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  column_spec(1,width = "12em")%>%
  column_spec(2:length(colnames(table)),width = "6em")%>%
  column_spec(7,italic=TRUE,bold=T,color = "red")%>%
  add_footnote( "P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses",notation = "symbol")

```

From `r table_nums("t4",display = "cite")` and `r table_nums("t5",display = "cite")` here is, as example, the computation of *Food processing* of Wheat,Flour of wheat and Starch of wheat: 

\begin{equation}
\begin{multlined}
\label{eq:wheatFP}
FP_{wheat_{2014}} = \left(70,500,000/0.78\right)\times 1\times 1 +\left(21,414,729/0.8\right)\times 1\times 0 = 90,384,615
\end{multlined}
\end{equation}

\begin{equation}
\begin{multlined}
\label{eq:flourFP}
FP_{flourW_{2014}} = \left(1,415,692/1\right)\times 1\times 1 +\left(15,486/1\right)\times 1\times 1 
+\left(193,950/1\right)\times 1\times 1
+\\
\left(239,816/0.75\right)\times 1\times 1 +
\left(116,496/1\right)\times 1\times 0 +\left(13,263/1\right)\times 1\times 1= 1,958,146
\end{multlined}
\end{equation}


\begin{equation}
\begin{multlined}
\label{eq:starchFP}
FP_{starchW_{2014}} = \left(158,665/1\right)\times 1\times 1 +\left(21,414,729/0.8\right)\times 1\times 0 = 158,665
\end{multlined}
\end{equation}


### Step 3: Filling of other missing utilizations {-}

After *Food processing* figures have been computed, the other variables have to be checked and either filled, increased or decreased. Only derived commodities enter this step. Primary commodities are excluded because for these commodities, the figures are normally more reliable and complete and, very often protected. Only the final balancing may affect Primary commodity figures.
This step is based on the value of the following Imbalance:

\begin{equation}
\label{eq:imbalance2}
Imb_{2} = P_{ijt} + I_{ijt} - X_{ijt} - \Delta St_{ijt} - Fo_{ijt} - Fe_{ijt} - Lo_{ijt} - Se_{ijt} - IU_{ijt} - T_{ijt}
\end{equation}

`r table_nums("t6",display = "cite")` reports $Imb2$ for all the lines of the SUAs of our example. 

Three different scenarios con be found (Figure 5): 

```{r f5, fig.align = "center", out.width = "80%", fig.cap = "\\label{fig:f5}Scenarios of the sua filling"}

knitr::include_graphics("images/05_ScenariosFilling.pdf")

```


```{r t6, fig.cap=t6_cap}
table=data.table(read.csv("tables/06_sua_unbalanced_imb2.csv"))
landscape(knitr::kable(table,format="latex",caption = "Sua table with Imb2 (Example China Mainland, Wheat 2014)",
             align = c("r",rep("l",length(colnames(table))-1)))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down", full_width = T))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  column_spec(3:length(colnames(table)),bold=FALSE, italic=FALSE,color = "black",width = "6em")%>%
  column_spec(1,width = "10em")%>%
  column_spec(14,color = "red",bold=T, italic=T)%>%
add_footnote( "P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses",notation = "symbol")
```

Please notice that, besides export and stock Variations, that are excluded from this step for the reasons previously explained, also Food Procesisng is excluded from the next steps, because $FP$ is related to the production figures of the children and to modify it, would detach this very important parent-children link. 


### - *Imbalance = 0 (Scenario A)* {-}

In this scenario the Imbalance is null, this meaning that there is enought supply for the existing utilizations. In This case the SUA line is balanced and nothig happens for the commodity. In `r table_nums("t6",display = "cite")` this is the case of *Other Fructose and syrup* and *wheat Gluten*.


### - *Imbalance < 0 (Scenario B)* {-}

If this happens, it means that there is not enough supply for the commodity to be used in the way the SUA figures suggest. First of all it has to be rembered that, as said in a previous section, trade figures are never changed during the filling process, this meaning that, if there is a need for interveening on supply, only production figures might be taken into account. In this case, as shown in Figure \ref{fig:f6} a distinction as to be made as of the Production figure is protected or not.

 * If Production figure is not protected, it is interpreted as if there was not enough information for producing a correct production number, therefore, this figure is changed, i.e. created, if missing, or incremented. 
 * If Production figure is protected, it should never be touched, therefore the algoritm tries to solve the eccess of utilization by reducing all the existing utilizations by 30% (except Exports^[Stock is changed in this case, because this is just a proportional reduction of values and does not need a time series analysis]). If this is enough to cover the Utilization, the balancing line for that commodity is balanced and the process can go to the next step. After the reduction by 30%, the imbalance $Imb2$ is recalculated and it can give two different results: 

> -- If this imbalance is still negative a warning is given that tells that there is an unsolvable problem and that all figures have to be checked because either the production protected figure is wrong, or the Trade or some utilization have to be changed. 

> -- If the imbalance becomes positive, the line falls into the Scenario C that will be explained shortly.

*Starch of Wheat* belongs to this very last case. Indeed, it has a negative Imbalance therefore its utilizations (except those utilizations that are completely excluded from this process) are reduced by 30% of their values (see `r table_nums("t7",display = "cite")`). After that happens, the Imb2 is recalculated and it is still negative, equal to $74,204$ (this value is not reported in the table). In the following step, as the production is not protected, the new value of production is equal to: 

\begin{equation}
\label{eq:prod}
P_{StarchW} = 239,816 + 74,204 = 314,020
\end{equation}

Remember that the commodity *Mixes and dough for the preparation of baker's wares*is considered here as a primary commodity, therefore it will not balanced even if it has a negative imbalance.

```{r f6, fig.align = "center", fig.cap = "\\label{fig:f5}Workflow of Sua Filling when there is a negative imbalance"}

knitr::include_graphics("images/06_NegativeImbalance.pdf")

```

```{r t7, fig.cap=t7_cap}
table=data.table(read.csv("tables/07_sua_unbalanced_imb2B.csv"))
landscape(knitr::kable(table,format="latex",caption = "Sua table with utilizations filled (Example China Mainland, Wheat 2014)",
             align = c("r",rep("l",length(colnames(table))-1)))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down", full_width = T))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  column_spec(3:length(colnames(table)),bold=FALSE, italic=FALSE,color = "black",width = "6em")%>%
  column_spec(1,width = "10em")%>%
  column_spec(14,color = "red",bold=T, italic=T)%>%
add_footnote( "P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses",notation = "symbol")
```


### - *Imbalance > 0 (Scenario C)* {-}

When $Imb2 >0$ there is an excess of supply that has to be distributed trought utilizations. Here:  

 * A *Utilization Table* tells which figures are supposed to be filled.
 * The Imbalance is distributed among variables according to a, so called, *Multiple Filler approach* which make use of the *Inverse Ranking Rule*. 
 

### --> The *Utilization table* {-}

Utilization table is a Country/commodity table telling which Utilizations historically have been active for each commodity and assigning a Rank and an inverse rank to each utilization based on its mean value over the period 2000-2013. `r table_nums("t8",display = "cite")` shows the Utilization table for *Wheat and meslin flour* in China Mainland.


```{r t8, fig.cap=t8_cap, fig.pos = "H"}
table=data.table(read.csv("tables/08_FlourWheatUtilizationT.csv"))
knitr::kable(table,caption = "Utilization Table Wheat and meslin Flour China Mainland 2014",
             align = c(rep("c",length(colnames(table))-1)))

```

Where $1248$ is the m49 code for China Mainland and $23110$ is the cpc code of Wheat and Meslin Flour. The table tells the following information: 

 1. The reported commodity in China, as been historically used:
  * for producing other commodities (*Food Processing*),
  * for human consumption (*Food*),
  * for increasing stocks (*Stock Variation*),
  * for exports (*exports*).
 2. The biggest amount of availability of the reported commodity was used for Human consumption, the second big for processing other commodity, then for exports and, in the end, for increasing stocks.

These informations are combined with the amount of *Imb2* for filling the SUAs of each derived commodity according to a set of rules all falling into the, so called, *Multiple Filler approach*.

### --> The *Multiple Filler Approach* and the *Inverse Ranking Rule* {-}

This approach distribute the $Imb2$ across utilizations, by the ules reported in Figure \ref{fig:f7}.


```{r f7, fig.align = "center",  fig.cap = "\\label{fig:f5}Workflow of Sua Filling when there is a positive imbalance"}

knitr::include_graphics("images/07_PositiveImbalance.pdf")

```

As reported in the Figure, Three cases may happen: 

1. If all the ranked utilizations are already filled, all of them are increased proportionally to their values. *Bran of Wheat* in our example, belongs to this case. Utilization table for Bran of Wheat is reported in `r table_nums("t9",display = "cite")`


```{r t9, fig.cap=t9_cap, fig.pos = "H"}
table=data.table(read.csv("tables/09_BranWheatUtilizationT.csv"))
knitr::kable(table,caption = "Utilization Table Bran ofWheat China Mainland 2014",
             align = c(rep("c",length(colnames(table))-1)))

```
  

> According to this table, there are 3 Utilizations that are suppose to be active for this commodity: *feed*, *food* and *exports*. *Exports* is excluded from this step, therefore, food and feed reamain. Both Variables are filled in the SUA line of This Commodity, therefore, all of them are increased proportionally to their values. 

2. If all the ranked utilizations are already filled but one, the all imbalance goes to that commodity. In our Example, this is the case of *Gluten Feed and meals* (`r table_nums("t9",display = "cite")`).


3. Finally, if more that one utilization is empty, the so called ***Inverse Ranking rule*** is activated. This rule assigns part of the imbalance to the ranked utilizations proportionally to the ranks. This happens by making use of the inverse rank of all the utilizations that are "activable" and not excluded from the procedure. The rule works for any number of ranks and independently from the number of utilizations that have to be excluded. 

> The *Inverse ranking rule* starts from the Utilization table with the addition of a column containing the *rank weigth $Wr$*, as reported in the following table: 


> \begin{center}
\begin{tabular}{ c|c|c|c } 
 \hline
element ($Ut_{i}$) & rank ($r_{i}$) & Inverse rank ($Ir_{i}$) & weight Rank ($Wr_{i}$)\\
 \hline
$Ut_{1}$ & $r_{1}$ & $Ir_{1}$  & $Wr_{1}$\\ 
... & ... & ... & ...\\ 
$Ut_{i}$ & $r_{i}$ & $Ir_{i}$  & $Wr_{i}$\\ 
... & ... & ... & ...\\ 
$Ut_{n}$ & $r_{n}$ & $Ir_{n}$  & $Wr_{n}$\\ 
 \hline
\end{tabular}
\end{center}

> where: 

> * $Ut_{i}$ is the generic utilization, with $i=1,2,...n$
> * $r_{i}$ is the rank of utilization $Ut_{i}$, with $i=1,2,...n$
> * $Ir_{i}$ is the Inverse rank of utilization $Ut_{i}$, with $i=1,2,...n$ and is equal to: 

>> \begin{equation}
\label{eq:inverseRankequation}
Ir_{i} = max(r)-r_{i}+1
\end{equation} 

> * $Wr_{i}$ is the rank weight of utilization $Ut_{i}$ and is equal to 0 or 1 depending on the element being, respectively, exluded or not from the sua filling (`r table_nums("t10",display = "cite")`). 

```{r t10, fig.cap=t10_cap, fig.pos = "H"}
table=data.table(read.csv("tables/10_RankWeightTable.csv"))
knitr::kable(table,caption = "Rank Weight of the elements of FBS",
             align = c(rep("c",length(colnames(table))-1)))

```


> The value $Value_{i}$ assigned to the utilization of each commodity is calculated as a rank based proportion $pR_{i}$ of the total $Imb2$ according to the following equation:

> \begin{equation}
\label{eq:inverseRank}
Value_{i} = Imb2 \times pR_{i}
\end{equation}

> with $pR_{i}$ depending on $\sum \limits_{i=1}^n Wr_{i}$:


> \begin{equation}
\label{eq:weightRank}
\begin{cases}
   pR_{i} = 0     & \quad \text{when} \quad \sum \limits_{i=1}^n Wr_{i} = 0\\
   pR_{i} = \frac{Ir_{i}\times we_{i}}{\sum \limits_{i=1}^n\left(Ir_{i}\times Wr_{i}\right)}     & \quad \text{when} \quad \sum \limits_{i=1}^n Wr_{i} > 0 
\end{cases}
\end{equation}

> 
> 

> As an example consider the SUA line of *Cocoa Beans* in Madagascar in 2014 (`r table_nums("t11",display = "cite")`) and the Utilization table of the same country/commodity combination (`r table_nums("t12",display = "cite")`)

```{r t11, fig.cap=t11_cap, fig.pos = "H"}
table=data.table(read.csv("tables/11_cocoaBeans.csv"))
knitr::kable(table,caption = "Sua line of Cocoa Beans Madagascar 2014 - before Sua Filling",
             align = c(rep("c",length(colnames(table))-1)))

```

```{r t12, fig.cap=t12_cap, fig.pos = "H"}
table=data.table(read.csv("tables/12_cocoaUtilizationT.csv"))
knitr::kable(table,caption = "Utilization table for Cocoa Beans Madagascar",
             align = c(rep("c",length(colnames(table))-1)))

```

> Besides the excluded elements, there are 2 utilizations empty: *food* and *Industrial Use*. The Values of these two elements is calculated as folows: 

> \begin{equation}
\begin{aligned}
  pR_{Fo} &= \frac{4\times 1}{0 + 0 + 4 + 3 + 0 + 0} = 4/7 = 0.57143 \\
  Value_{Fo} &= 1,832 \times 0.57143 = 1,047 
\end{aligned}
\end{equation}

> 

> \begin{equation}
\begin{aligned}
\label{eq:VIUC}
  pR_{IU} &= \frac{3\times 1}{0 + 0 + 4 + 3 + 0 + 0} = 3/7 = 0.42857\\
  Value_{IU} &= 1,832 \times 0.42857 = 785
\end{aligned}
\end{equation}


```{r t13, fig.cap=t13_cap, fig.pos = "H"}
table=data.table(read.csv("tables/13_cocoaBeansBal.csv"))
knitr::kable(table,caption = "Sua line of Cocoa Beans Madagascar 2014 - after Sua Filling",
             align = c(rep("c",length(colnames(table))-1)))

```

