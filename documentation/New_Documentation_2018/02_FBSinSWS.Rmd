---
title:   |
    | Food Balance Sheet workflow
    | in the Statistical Working System
    |  
header-includes:
- \usepackage{draftwatermark}   
- \usepackage{makeidx}
- \makeindex
- \usepackage{float} #use the 'float' package
- \floatplacement{figure}{H} #make every figure with caption = h
- \usepackage{amsmath}
- \usepackage{amssymb}
- \usepackage{amsthm}
- \usepackage{mathtools}
author:
- Cristina Muschitiello\

  Food and Agriculture Organization of the United Nations
  
abstract: |
  This vignette provides a description of the workflow and dependencies of operations in the Statistical Working System for the production of Food Balance Sheets.
date: "`r format(Sys.time(), '%e %B %Y')`"
geometry: margin=1in
output:
  pdf_document:
    keep_tex: true
    fig_caption: yes
    includes:
      in_header: header.tex
    pandoc_args: [
    --tab-stop=2
    ]
    number_sections: true
    toc: true
    toc_depth: 4
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# local({
# r <- getOption("repos")
# r["faoswsCRAN"] <- "http://hqlprsws1.hq.un.fao.org/fao-sws-cran/"
# options(repos = r)
# })
## load the library
# library(faosws)
# library(faoswsUtil)
# library(faoswsBalancing)
# library(faoswsStandardization)
library(tinytex)
library(data.table)
library(igraph)
library(stringr)
library(dplyr)
library(MASS) 
library(lattice)
library(reshape2)
library(kableExtra)
library(captioner)
library(xtable)
```


```{r}
# DEFINE ALL TABLE NAMES AND CAPTIONS
table_nums <- captioner::captioner(prefix = "Table")
t1_cap <- table_nums(name = "t1",
                     caption = "Unbalanced Sua table - China/Wheat/2014 example")
t2_cap <- table_nums(name = "t2", 
                        caption = "Sua table with Imb1 - China/Wheat/2014 example")

t3_cap <- table_nums(name = "t3", 
                        caption = "Sua table with Production filled/incremented - China/Wheat/2014 example")

t4_cap <- table_nums(name = "t4", 
                        caption = "Commodity Tree  with weights - China/Wheat/2014 example")

t5_cap <- table_nums(name = "t5", 
                        caption = "Sua table with Food Processing filled - China/Wheat/2014 example")

t6_cap <- table_nums(name = "t6", 
                        caption = "Sua table with Imb2 - China/Wheat/2014 example")

t7_cap <- table_nums(name = "t7", 
                        caption = "Sua table with Utilizations filled - China/Wheat/2014 example")

t8_cap <- table_nums(name = "t8", 
                        caption = "*Utilization Table* Wheat and meslin Flour - China/Wheat/2014 example")

t9_cap <- table_nums(name = "t9", 
                        caption = "*Utilization Table* Bran of Wheat - China/Wheat/2014 example")

```


\newpage

\listoftables

\listoffigures

\newpage

## Disclaimer {-}

This Working Paper should not be reported as representing the official view of
the FAO. The views expressed in this Working Paper are those of the
author and do not necessarily represent those of the FAO or FAO
policy. Working Papers describe research in progress by the authors and
are published to elicit comments and to further discussion.

This paper is dynamically generated on \today{} and is subject to
changes and updates.

# The Overall Workflow of The FBS {-}

The process of creating FBSs starts by collecting all data for the different variables of the Food Balance Sheet Framework^[For definitions and an extended description of the motivation behind the development of FBS, see FAO, 2001, *Food Balance Sheets: A Handbook*, available at: http://www.fao.org/docrep/003/X9892E/X9892E00.HTM. Accessed on 19 January 2017. Moreover see *Standardization & Balancing for Food Balance Sheet Calculation*, in the *Standardization & Balancing* module's documentation on [*GitHub*](https://github.com/SWS-Methodology/faoswsStandardization/tree/master/documentation)]. The data of each variable are generally checked and imputed in time series. The set of operations required for creating/checking time series of data for each variable is called *module*. A ***module***, in the FBS Framework, is an R-script, written by an R-developer and integrate inside the ***Statistical Working System (SWS)***^[SWS is an internal Working System providing a platform for statisticians and statistical clers to collect, collate, validate and correct data. Moreover, the platfors supports the possibility of performing imputations of data based on statisticians' knowledge and development.] by means of *plugins*. There is at least one module (there might be more) for each variable of the FBS. Each module produces figures that are collected in a dataset inside the SWS for future uses or publication. Output data of a module may become input data of another module, this circumstance creating a precise sequence for the execution of a complete FBS.

# Definitions {-}



# B. Standardization and Balancing {-}

# The Overall Workflow 

The *Standardiation & Balancing* process is presented in Figure \ref{fig:f9}. It involves 5 main steps and requires a some auxiliary information table. 

The 5 steps are: 

 1. Data Pull, 
 2. Sua Filling,
 3. Standardization, 
 4. Balancing,
 5. FBS aggregation. 

The additional information's tables are: 

 * *Utilization Table*,
 * *Zero-Weight* table,
 * *cut* table,
 * *Fbs Tree*.
 
All the steps and the table will be described across the present document, after having introduced the the basic equation of FBS and the *Commodity tree* which represents the structure of the set of commodity involved in the Food Balance Sheets. 
  
```{r f9, fig.align = "center", fig.pos = "H",out.width = "80%",  fig.cap = "\\label{fig:f9}Standardization and Balancing Overall Workflow"}

knitr::include_graphics("images/09_overall.pdf")
```


# Commodity Tree {-}

The process of combining commodity balances for creating Food Balance Sheets is based on a structured and clear set of relationships between commodity given by the *Commodity tree*.
The majority of the commodities are produced from one (or more) commodity (/ies), called *parent* commodity(/ies), and/or are themselfes parent of one (or more) *child* (*children*) commodity (/ies). These structure creates an intense and articulated network of relationships at different levels: primary commodities, like crops, are *parent* commodities and, also, *zero-level* commodities from which *children* commodities of *level-1* are produced, which are in turn, used to produce other commodities of a gradually *"lower"* level. In commodtity trees, the bigger the level number, the lower the processing level. There are as many commodity trees as the number of process chains in a country. Fundamental characteristics of commodity trees are^[For a more detailed description of commodity trees, please see the specific documentation. The reference document, at the moment is the *tecnical conversion factor* document available in the documentation folder on [*GitHub*](https://github.com/SWS-Methodology/faoswsStandardization/tree/master/documentation)]: 

 1. Each commodity tree is represented as a flowchart of the kind presented in Figure \ref{fig:f2} where:
  * ***nodes*** represent commodities, 
  * ***edges*** represent production processes ,
  * ***joints*** indicate where a single production process creates more that one commodity. These commodities are, then, called *by-products* or *co-products*.

```{r f2, fig.align = "center", fig.pos = "H",  fig.cap = "\\label{fig:f2}Commodity Tree for Wheat in China mainland 2014"}

knitr::include_graphics("images/02_WheatTree.pdf")
```


 2. Not all the countries have the same production processes, because countries have different technologies and primary products availabilities. Therefore, the commodity trees are not the same across countries.
 
 3. if a production process is active in a country, this is expressed throught the existence of a conversion factor called ***extraction Rate***. An Extraction rate ($eR$) represents how much amount of the child commodity is produced from 1 unit of parent commodity. It is expressed as a ratio of the processed product obtained from the processing of the parent/originating product.
  
 4. Some child commodities can be produced starting from more that one parent commodity. A second conversion factor exists representing the amount of a child commodity that is produced from each parent commodity. This conversion factor is called ***Share***. Shares represent the amount of the child commodity that is produced from the specified parent and are expressed as a ratio. Shares are generically defined as: 
 
> \begin{equation}
\label{eq:sharesGen}
s_{cp} = \frac{availability_{p(c)}}{\sum \limits_{p=1}^A{availability_{p(c)}}}
\end{equation}

> where $availability_{p(c)}$ is the availability of each parent $p$ of child $c$ expressed in terms of $c$ (in *child equivalent*).

Commodity trees are presented in tables like `r table_nums("t15",display = "cite")`, which represents the same example of Figure \ref{fig:f2}. In the table each production process is represented in a separate row. 

There are some concepts linked to the *Commodity tree* framework: 

 * ***Proxy-Primary*** commodities. These are a set of commodities that are children of other commodities but, because they are important in representing the food availability of a country, are not aggregated to their primary commodities, but are kept separated. These commodities are *cut* from the tree of the primary commodity/ies and, if they can be processed in other products, have their own commodity tree. The name *proxy-primary* is assigned because they are considered as primary-commodities in the *Standardization & Balancing* process.
 * ***No-Tree*** commodities. These are *zero-level* commodities that are primary commodities and are never processed in other products. As they are not involved in any production process, there is no tree associated to them. Notice that, even a commodity that is included in the commodity tree of one Country, might be a No-tree commodity for another country or another year, if no production processes have been activated for that specific Country or year.

# Data Pull

The process of creating FBSs starts by considering the initial commodity balance for each CPC commodity, either primary and derived, with the different variables of the equation (as listed and briefly described in the previous section) filled with figures as available from official or other sources and from imputation and estimation methods, when applied. In other words, the process starts by pulling figures inside a so-called *Sua Unbalanced*.
In this initial account, food processing and ROU figures are not available (because they, by default, will be measured during the process), whereas the figures for all other variables have been already collected, imputed and estimated through a specific *module* (Figure \ref{fig:f1}).

A ***module***, in the FBS Framework, is an R-script, written by an R-developer, for the execution of a set of operations (either data import, manipulation, imputation or estimation) required for compiling the time series of one variable. There is at least one module (there might be more) for each variable of the FBS. Each module produces figures that are collected in a dataset inside the ***Statistical Working System (SWS)***^[SWS is an internal Working System providing a platform for statisticians and statistical clers to collect, collate, validate and correct data. Moreover, the platfors supports the possibility of performing imputations of data based on statisticians' knowledge and development.].Output data of a module may become input data of another module, this circumstance creating a precise sequence for the execution of a complete FBS. In the present document, we are analyzing the workflow of the Standardization process as starts after all the modules have run and have produced reliable data or each variable. The detailed description of the workflow for the execution of all the modules of the FBS will be given in a separate document.^[[report the document when it will be available]].

```{r f1, fig.cap = "\\label{fig:f1}Data Pull from datasets containing data for each separate variable"}
knitr::include_graphics("images/01_pulldata.pdf")
```



## the Initial Sua Unbalanced {-}

After pulling all data, the process of compiling Food Balance Sheets is a non-complete supply-utilization account. The non-completeness of the SUAs is due to different reasons: first, as already said, some variables are not collected, nor estimated before the process begins, second there is the model for industrial use that does not impute or estimate data, but just collects data from different sources, this opening the strong possibility not to have values where they are supposed to exist and, also, not guaranteeing consistency of data over time. Thirdly, modules might, sometimes, fail in the imputation, because of the strong complexity and structural diversity of the input data. 

```{r t1, fig.cap=t1_cap}
table=data.table(read.csv("tables/01_sua_unbalanced.csv"))
landscape(knitr::kable(table,format="latex",caption = "Unbalanced Sua table - China/Wheat/2014 example",
             align = c("r",rep("l",length(colnames(table))-1)))) %>% 
  kable_styling(font_size = 18,latex_options=c("scale_down", full_width = T))%>%
  row_spec(0, bold=TRUE, align = c("r",rep('c',times=length(colnames(table))-1))) %>%
  row_spec(1, italic=TRUE) %>%
  column_spec(1,width = "12em")%>%
  column_spec(2:length(colnames(table)),width = "6em")%>%
  add_footnote( "P=Production, I=Import, X=Export, DSt=Delta Stock, Fo=Food Availability, FP=FoodProcessing, Fe=Feed, Se=Seed, T=Tourism Consumption, IU=IndustrialUse, L=Loss, ROU=Residual and other uses",notation = "alphabet")
```

S